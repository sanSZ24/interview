---
typora-root-url: ./
---

## TCP协议

##### 基础知识

- TCP报文基本格式

  - **序列号**：在建立连接时由计算机生成的随机数作为其初始值，通过 SYN 包传给接收端主机，每发送一次数据，就累加一次该数据字节数的大小。**用来解决网络包乱序问题。**
  - **确认序列**：指下一次期望收到的数据的序列号，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。**用来解决丢包的问题。**
  - **控制位：**
    - *ACK*：该位为 `1` 时，「确认应答」的字段变为有效，TCP 规定除了最初建立连接时的 `SYN` 包之外该位必须设置为 `1` 。
    - *RST*：该位为 `1` 时，表示 TCP 连接中出现异常必须强制断开连接。
    - *SYN*：该位为 `1` 时，表示希望建立连接，并在其「序列号」的字段进行序列号初始值的设定。
    - *FIN*：该位为 `1` 时，表示今后不会再有数据发送，希望断开连接。当通信结束希望断开连接时，通信双方的主机之间就可以相互交换 `FIN` 位为 1 的 TCP 段。

  ![](/assets/TCP.webp)



- TCP是**面向连接的、可靠的、基于字节流的传输层通信协议**。
  - 面向连接：一定是一对一才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息。
  - 可靠的：TCP 可以保证一个报文一定能够到达接收端。
  - 字节流：用户消息通过 TCP 协议传输时，消息可能会被操作系统「分组」成多个的 TCP 报文，如果接收方的程序如果不知道「消息的边界」，是无法读出一个有效的用户消息的。并且 TCP 报文是「有序的」，当「前一个」TCP 报文没有收到的时候，即使它先收到了后面的 TCP 报文，那么也不能扔给应用层去处理，同时对「重复」的 TCP 报文会自动丢弃



- TCP连接：**用于保证可靠性和流量控制维护的某些状态信息**，包括以下部分
  - **Socket**：由 IP 地址和端口号组成
  - **序列号**：用来解决乱序问题等
  - **窗口大小**：用来做流量控制



<h5>TCP与UDP

- UDP报文结构

  - 包长度：该字段保存了 UDP 首部的长度跟数据的长度之和。
  - 校验和：校验和是为了提供可靠的 UDP 首部和数据而设计，防止收到在网络传输中受损的 UDP 包。

  ![](/assets/UDP.webp)



- TCP和UDP的区别
  - 连接: TCP是面向连接的，传输前需要建立连接；而UDP不需要建立连接，即刻传输数据。
  - 服务对象：TCP是一对一，UDP支持一对一、一对多、多对多的交互通信。
  - 可靠性：TCP是可靠的，能确保数据完整的交付；而UDP是是尽最大努力交付，不保证数据完整的交付。
  - 拥塞控制、流量控制：TCP有这个功能，UDP没有。
  - 首部开销：根据报文结构就可以得知，TCP首部开销大，UDP开销小。
  - 传输方式：TCP是流式传输，没有边界，但保证顺序和可靠；UDP 是一个包一个包的发送，是有边界的，但可能会丢包和乱序。



- TCP与UDP的应用场景：
  - TCP常用于FTP文件传输，HTTP/HTTPS
  - UDP常用于包总量较少的通信，视频、音频等多媒体通信，广播通信。



<h5>TCP建立连接与断开连接

- 建立连接：三次握手。

  - 三次握手的原因：避免历史连接、同步双方初始序列号、避免资源浪费。

  > **第三次握手是可以携带数据的，前两次握手是不可以携带数据的**

- 断开连接：四次挥手。

  ![](/assets/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.webp)



<h5>实现TCP的可靠数据传输

- 重传机制：主要有**回退N步**和**选择重传**，**快速重传**。
- 流量控制：通过让发送方维护一个称为接收窗口的变量来提供流量控制，用以消除发送方使接收方缓存溢出的可能性。
- 拥塞控制：让发送方根据所感知到的网络拥塞程度来限制其能向连接发送流量的速率。
  - 慢启动：当发送方每收到一个 ACK，拥塞窗口 cwnd 的大小就会加 1。
  - 拥塞避免：当拥塞窗口 `cwnd` 「超过」慢启动门限 `ssthresh` 就会进入拥塞避免算法。**每当收到一个 ACK 时，cwnd 增加 1/cwnd**
  - 快速恢复：



<h5>优化TCP

- TCP 三次握手的性能提升：
  - 客户端优化：调整客户端的三次握手时间上限。
  - 服务端优化：调整服务端配置。
  - 绕过三次握手：将第一次建立连接的信息保存到本地，然后在下一次连接时使用这个信息，可以减少一次握手。
- TCP 四次挥手的性能提升：
- TCP 数据传输的性能提升：
  - 增大TCP的拥塞窗口。
  - 调整发送缓冲区和接收缓冲区的范围。



<h5>TCP的缺陷

- 升级 TCP 的工作很困难。
- TCP 建立连接的延迟。
- TCP 存在队头阻塞问题。TCP 是字节流协议，**TCP 层必须保证收到的字节数据是完整且有序的**，如果序列号较低的 TCP 段在网络传输中丢失了，即使序列号较高的 TCP 段已经被接收了，应用层也无法从内核中读取到这部分数据
- 网络迁移需要重新建立 TCP 连接。